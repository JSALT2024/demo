# How to develop

I used VS Code to develop both the frontend and the backend simultaneously. You only need the python extenstion, there is no extension needed for the frontend part.

This repository comes with the `.vscode` folder, that defines the proper tab size for all the used file formats and also defines a ruler at 80 characters. Keeping the maximum code width to 80 characters makes it easier to develop the code on a laptop and to preview the code from a mobile device from GitHub. It's not a hard rule, but I'd recommend sticking to it.


## Backend

If you have a GPU that can run LLaMa (all other models can run on CPU as well), or you want to develop a part of the backend that does not require execution of this model, you can develop the backend on your local machine.

Simply run the `make start` command in the backend folder and it should watch for filesystem changes and update the running HTTP server accordingly.

If you don't have a GPU, you can develop the backend part on a cluster. Simply clone the repository there and set it up as usual (see the [Installing on Rockfish and your laptop](./installing-on-rockfish-and-your-laptop.md) tutorial). Then use the VS Code [Remote Development](https://code.visualstudio.com/docs/remote/remote-overview) via SSH to edit the code on the cluster filesystem directly. Note that, in this setup you may need to restart the server whenever you do a code change, as filesystem watching may not work. Also make sure you run the server in an interactive job with a GPU, not on the login node. And also make sure your SSH tunnel works, if you want to test the HTTP interface of the web server.

One way of debugging a certain new part of the backend server is to make the file in question directly executable by adding the `if __name__ == "__main__":` block and then just calling it from within the interactive job:

```bash
.venv/bin/python3 -m app.foo.bar.my_new_file
```

With this setup you will also want to commit changes from the cluster directly, so you should probbably [set up an SSH key](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account) there.


## Frontend

Frontend is much easier to setup development for. But it cannot really be developed on its own, it needs to have the backend server running. So before you start frontend development, start up the backend server either locally, or on a cluster with the SSH tunnel (see the [Installing on Rockfish and your laptop](./installing-on-rockfish-and-your-laptop.md) tutorial).

It's best to have the repository cloned locally on your machine, and having the `frontend` folder set up so that the `npm run start` command runs (see the [frontend README file](../frontend/README.md)). The `npm run start` command launches the Parcel development server, which begins hosting the frontend at http://localhost:1234 and also watches for file changes and triggers re-compilation and even [hot-reloads](https://parceljs.org/features/development/#hot-reloading) the app in your browser without the need for you to refresh.

Note that sometimes the hot reload fails, so when you see an error, try reloading the page first, before tracing the source of the issue. Also, Parcel sometimes gets its cache corrupted so that it fails to resolve a new `import` statement in your new code. If that happens, try killing the parcel server and starting it up again.


## Fullstack

What I ended up using at the end is having the repository cloned on both the cluster and my local machine. I had 2 VS Code instances openned, one local for frontend and one with remote development on the cluster. I had frontend running locally via `npm run start` and backend running on the cluster inside an interactive job via `make start`. I had the SSH tunnel set up. It's exactly this diagram:

<img src="img/rockfish-ssh-setup.svg" alt="Diagram of the Rockfish setup with the SSH tunnel" />

This way I could change the backend and frontend together and when the new feature was working, I'd commit the backend first, push from the cluster. Then pull on my machine, commit the frontend there, and push from my local machine. This way I sort of developed the backend first and then the frontend, while in reality I could develop both at the same time.

Also note that you can develop the backend first, independently, just by manually acessing the http://localhost:1817 URL. The home page contains a link to a [Swagger page](https://editor.swagger.io/) generated by the [FastApi framework](https://fastapi.tiangolo.com/) and you can use that page to manually send HTTP requests to backend endpoints and examine the responses. Once that is done, you can commit and then develop the frontend separately.

There are many ways how to develop the backend:

- custom test code via `.venv/bin/python3 -m app.foo.bar.my_new_file`
- adding proper [unit tests](https://realpython.com/pytest-python-testing/)
- making HTTP requests via the Swagger page
- making requests directly from a WIP frontend part

The choice depends on the feature you are adding.

On the other hand, developing frontend is always the same and simple. Just start the parcel server, modify the code, and see the result in the browser.

Now that you know how to setup the development environment, you should learn about the architecture of both the backend and the frontend to get acustomed to the code structure and then you can start poking around in the codebase. Continue with reading the [Architecture file](architecture.md).
